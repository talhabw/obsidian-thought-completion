var k=Object.defineProperty;var G=Object.getOwnPropertyDescriptor;var F=Object.getOwnPropertyNames;var z=Object.prototype.hasOwnProperty;var $=(s,t)=>{for(var i in t)k(s,i,{get:t[i],enumerable:!0})},j=(s,t,i,e)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of F(t))!z.call(s,n)&&n!==i&&k(s,n,{get:()=>t[n],enumerable:!(e=G(t,n))||e.enumerable});return s};var J=s=>j(k({},"__esModule",{value:!0}),s);var rt={};$(rt,{default:()=>O});module.exports=J(rt);var P=require("obsidian");var V={apiEndpoint:"https://api.openai.com/v1",apiKey:"",model:"gpt-4o-mini",mode:"auto",triggerDelay:2e3,triggerOnPunctuation:!0,triggerOnNewline:!0,manualTriggerOnly:!1,contextChars:1500,includeHeadingTrail:!0,maxTokens:500,temperature:.7,enabled:!0,suggestionCase:"none",showStatusBar:!1};var a=require("obsidian"),b=class extends a.PluginSettingTab{constructor(t,i){super(t,i),this.plugin=i}display(){let{containerEl:t}=this;t.empty(),new a.Setting(t).setName("Enable suggestions").setDesc("Turn thought suggestions on or off").addToggle(i=>i.setValue(this.plugin.settings.enabled).onChange(async e=>{this.plugin.settings.enabled=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("API configuration").setHeading(),new a.Setting(t).setName("API endpoint").setDesc("OpenAI-compatible API endpoint (e.g., https://api.openai.com/v1)").addText(i=>i.setPlaceholder("https://api.openai.com/v1").setValue(this.plugin.settings.apiEndpoint).onChange(async e=>{this.plugin.settings.apiEndpoint=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("API key").setDesc("Your API key (stored locally)").addText(i=>{i.setPlaceholder("sk-...").setValue(this.plugin.settings.apiKey).onChange(async e=>{this.plugin.settings.apiKey=e,await this.plugin.saveSettings()}),i.inputEl.type="password"}),new a.Setting(t).setName("Model").setDesc("Model name to use (e.g., gpt-4o-mini, claude-3-haiku)").addText(i=>i.setPlaceholder("gpt-4o-mini").setValue(this.plugin.settings.model).onChange(async e=>{this.plugin.settings.model=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Suggestion style").setHeading(),new a.Setting(t).setName("Mode").setDesc("What type of thinking nudges do you want?").addDropdown(i=>i.addOption("auto","Auto (AI picks)").addOption("questions","Questions (thought-provoking)").addOption("structural","Structural (organization)").addOption("critical","Critical (counterpoints)").addOption("connector","Connector (links & connections)").setValue(this.plugin.settings.mode).onChange(async e=>{this.plugin.settings.mode=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Letter case").setDesc("Transform suggestion capitalization").addDropdown(i=>i.addOption("none","Keep as-is").addOption("lower","all lowercase").addOption("firstLower","first letter lowercase").setValue(this.plugin.settings.suggestionCase).onChange(async e=>{this.plugin.settings.suggestionCase=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Triggers").setHeading(),new a.Setting(t).setName("Manual trigger only").setDesc("Only show suggestions when you manually trigger them (via command)").addToggle(i=>i.setValue(this.plugin.settings.manualTriggerOnly).onChange(async e=>{this.plugin.settings.manualTriggerOnly=e,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.manualTriggerOnly||(new a.Setting(t).setName("Trigger delay").setDesc("How long to wait after typing stops before suggesting (ms)").addSlider(i=>i.setLimits(500,5e3,100).setValue(this.plugin.settings.triggerDelay).setDynamicTooltip().onChange(async e=>{this.plugin.settings.triggerDelay=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Trigger on punctuation").setDesc("Suggest after sentence-ending punctuation (. ! ?)").addToggle(i=>i.setValue(this.plugin.settings.triggerOnPunctuation).onChange(async e=>{this.plugin.settings.triggerOnPunctuation=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Trigger on newline").setDesc("Suggest after pressing Enter").addToggle(i=>i.setValue(this.plugin.settings.triggerOnNewline).onChange(async e=>{this.plugin.settings.triggerOnNewline=e,await this.plugin.saveSettings()}))),new a.Setting(t).setName("Context").setHeading(),new a.Setting(t).setName("Context characters").setDesc("How much surrounding text to send to the AI (characters)").addSlider(i=>i.setLimits(500,4e3,100).setValue(this.plugin.settings.contextChars).setDynamicTooltip().onChange(async e=>{this.plugin.settings.contextChars=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Include heading trail").setDesc("Include the current heading hierarchy for context").addToggle(i=>i.setValue(this.plugin.settings.includeHeadingTrail).onChange(async e=>{this.plugin.settings.includeHeadingTrail=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Model parameters").setHeading(),new a.Setting(t).setName("Max tokens").setDesc("Maximum response length. Reasoning models need higher values (500+).").addSlider(i=>i.setLimits(50,2e3,50).setValue(this.plugin.settings.maxTokens).setDynamicTooltip().onChange(async e=>{this.plugin.settings.maxTokens=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Temperature").setDesc("Creativity level (0 = focused, 1 = creative)").addSlider(i=>i.setLimits(0,1,.1).setValue(this.plugin.settings.temperature).setDynamicTooltip().onChange(async e=>{this.plugin.settings.temperature=e,await this.plugin.saveSettings()})),new a.Setting(t).setName("Interface").setHeading(),new a.Setting(t).setName("Show status bar").setDesc("Show plugin state in the bottom status bar").addToggle(i=>i.setValue(this.plugin.settings.showStatusBar).onChange(async e=>{this.plugin.settings.showStatusBar=e,await this.plugin.saveSettings()}))}};var _={auto:`You are a "Thought Completion" engine for a writer. Your goal is NOT to write the content, but to suggest the cognitive direction the writer should take next.

Read the user's current text context. Determine the most helpful immediate next step (a question to answer, a counter-argument to consider, or a structural element to add).

Rules:
1. Output ONE short, punchy suggestion.
2. Keep it SHORT.
3. Do NOT continue their sentence literallly. Suggest the *idea* of what to write.

Examples:
- Context: "The problem with modern web design is..."
  Suggestion: "List the three main usability issues."
- Context: "We need to focus on user retention."
  Suggestion: "Ask: Why are users leaving currently?"
- Context: "This algorithm is efficient."
  Suggestion: "Contrast this with the brute-force approach."
Return ONLY the suggestion text.`,questions:`You are a Socratic questioning engine. Your goal is to provoke deep thinking by asking the right question at the right time.

Based on the provided notes, suggest a question that challenges the user or expands the scope.

Rules:
1. Output ONE deep question.
2. Keep it SHORT.
3. Do not answer the question.

Examples:
- "What is the underlying assumption here?"
- "Can this be applied to a different context?"
- "What evidence supports this claim?"

Return ONLY the question.`,structural:`You are a Structure and Outlining assistant. Your goal is to help the user organize their thoughts into a coherent format.

Analyze the current text and suggest the next structural move.

Rules:
1. Suggest a formatting action (e.g., create a list, summarize, define, conclude).
2. Keep it imperative and SHORT.

Examples:
- "Create a bulleted list of examples."
- "Summarize the key takeaway above."
- "Define the technical terms used."
- "Add a subheading for 'Implementation'."

Return ONLY the structural instruction.`,critical:`You are a Critical Thinking engine. Your role is to be the "Devil's Advocate."

Look at the user's last argument or statement and suggest a counter-point, a limitation, or a potential failure mode they should address.

Rules:
1. Suggest a specific angle of critique.
2. Keep it SHORT.
3. Be direct but neutral.

Examples:
- "Address the edge cases where this fails."
- "What is the strongest argument against this?"
- "Consider the long-term technical debt."
- "Check for survival bias in this logic."

Return ONLY the critique suggestion.`,connector:`You are a Networked Thought assistant. Your goal is to help the user connect the current idea to other concepts, mental models, or distinct fields.

Suggest a type of connection the user should look for.

Rules:
1. Prompt the user to link this concept to something else.
2. Keep it SHORT.
3. Use abstract mental models or general domains if you don't know their specific files.

Examples:
- "Connect this to a mental model from Physics."
- "How does this relate to your previous project?"
- "Compare this with [Specific Concept mentioned earlier]."
- "Synthesize this with the opposing view."

Return ONLY the connection prompt.`};function q(s,t,i){let e=[];return i&&(e.push(`Current section: ${i}`),e.push("")),e.push("Text:"),e.push("---"),e.push(s),e.push("[CURSOR - writer is here]"),t.trim()&&e.push(t),e.join(`
`)}function L(s){return _[s]}var X=!1;function c(...s){X&&console.log("[ThoughtCompletion:API]",...s)}var y=class{constructor(t){this.settings=t;this.abortController=null}updateSettings(t){this.settings=t}async complete(t){var i,e,n,o;if(this.abort(),!this.settings.apiKey||!this.settings.apiEndpoint)return console.warn("Thought Completion: API key or endpoint not configured"),null;this.abortController=new AbortController;try{let g=L(t.mode),u=q(t.prefix,t.suffix,t.headingTrail),h={model:this.settings.model,messages:[{role:"system",content:g},{role:"user",content:u}],max_tokens:this.settings.maxTokens,temperature:this.settings.temperature},f=`${this.settings.apiEndpoint}/chat/completions`;c("Request URL:",f),c("Request body:",JSON.stringify(h,null,2));let m=await fetch(f,{method:"POST",headers:{Authorization:`Bearer ${this.settings.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(h),signal:this.abortController.signal});if(c("Response status:",m.status),!m.ok){let I=await m.text();return c("Response error:",I),console.error("Thought Completion API error:",m.status,I),null}let d=await m.json();c("Response data:",JSON.stringify(d,null,2));let w=(o=(n=(e=(i=d.choices)==null?void 0:i[0])==null?void 0:e.message)==null?void 0:n.content)==null?void 0:o.trim();if(c("Extracted suggestion:",w||"(empty)"),!w)return c("No suggestion found in response"),null;let C=Z(w);c("Cleaned suggestion:",C);let T=tt(C,this.settings.suggestionCase);return c("Transformed suggestion:",T),T}catch(g){return g instanceof Error&&g.name==="AbortError"?(c("Request aborted"),null):(c("Request error:",g),console.error("Thought Completion error:",g),null)}finally{this.abortController=null}}abort(){this.abortController&&(this.abortController.abort(),this.abortController=null)}};function Z(s){let t=s;(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1));let i=["Suggestion: ","Consider: ","Think about: ","Question: ","Try: "];for(let e of i)if(t.startsWith(e)){t=t.slice(e.length);break}return t.trim()}function tt(s,t){if(!s||t==="none")return s;if(t==="lower")return s.toLowerCase();if(t==="firstLower"){if(s.length===0)return s;let i=s[0],e=s[1];return s.length===1||!e||e===e.toLowerCase()?i.toLowerCase()+s.slice(1):s}return s}function R(s,t,i){let e=s.state,n=e.selection.main.head,o=e.doc.toString(),g=Math.max(0,n-t),u=o.slice(g,n);if(g>0){let d=u.indexOf(`
`);d>0&&d<100&&(u=u.slice(d+1))}let h=Math.min(o.length,n+Math.floor(t/3)),f=o.slice(n,h);if(h<o.length){let d=f.lastIndexOf(`
`);d>0&&(f=f.slice(0,d))}let m="";return i&&(m=et(o,n)),{prefix:u,suffix:f,headingTrail:m,cursorPosition:n}}function et(s,t){let e=s.slice(0,t).split(`
`),n=[];for(let o of e){let g=o.match(/^(#{1,6})\s+(.+)$/);if(g){let u=g[1].length,h=g[2].trim();for(;n.length>0&&n[n.length-1].level>=u;)n.pop();n.push({level:u,text:h})}}return n.length===0?"":n.map(o=>o.text).join(" > ")}function D(s,t){return(s.slice(0,t).match(/^```/gm)||[]).length%2===1}function N(s,t){if(!s.startsWith(`---
`))return!1;let i=s.indexOf(`
---
`,4);return i===-1?t<s.indexOf(`
`,4)+100:t<=i+4}var p=require("@codemirror/view"),x=require("@codemirror/state"),M=class extends p.WidgetType{constructor(i){super();this.text=i}toDOM(){let i=document.createElement("span");return i.className="thought-completion-ghost",i.textContent=this.text,i}eq(i){return this.text===i.text}ignoreEvent(){return!0}},B=x.StateEffect.define(),A=x.StateField.define({create(){return{decorations:p.Decoration.none,suggestion:null}},update(s,t){let{suggestion:i}=s;for(let n of t.effects)n.is(B)&&(i=n.value);t.docChanged&&(i=null),i&&t.selection&&t.state.selection.main.head!==i.position&&(i=null);let e=p.Decoration.none;if(i)try{e=p.Decoration.set([p.Decoration.widget({widget:new M(i.text),side:1}).range(i.position)])}catch(n){i=null}return{decorations:e,suggestion:i}},provide:s=>p.EditorView.decorations.from(s,t=>t.decorations)});function it(s){return s.state.field(A).suggestion}function H(s,t){let i=s.state.selection.main.head;s.dispatch({effects:B.of({text:t,position:i})})}function S(s){s.dispatch({effects:B.of(null)})}function Y(s){return it(s)!==null}var st=!1;function r(...s){st&&console.log("[ThoughtCompletion]",...s)}var v=class{constructor(t){this.settings=t;this.state="idle";this.queueTimer=null;this.currentView=null;this.stateChangeCallbacks=[];this.aiProvider=new y(t),t.enabled||(this.state="disabled"),r("State machine created, initial state:",this.state)}getState(){return this.state}onStateChange(t){return this.stateChangeCallbacks.push(t),()=>{let i=this.stateChangeCallbacks.indexOf(t);i>-1&&this.stateChangeCallbacks.splice(i,1)}}updateSettings(t){this.settings=t,this.aiProvider.updateSettings(t),!t.enabled&&this.state!=="disabled"?this.disable():t.enabled&&this.state==="disabled"&&this.enable(),r("Settings updated, enabled:",t.enabled,"manualOnly:",t.manualTriggerOnly)}setView(t){this.currentView=t}trigger(t){if(r("trigger() called, current state:",this.state),this.state==="disabled"){r("trigger() ignored: disabled");return}if(this.settings.manualTriggerOnly){r("trigger() ignored: manualTriggerOnly");return}this.currentView=t;let i=t.state.doc.toString(),e=t.state.selection.main.head;if(D(i,e)){r("trigger() ignored: in code block");return}if(N(i,e)){r("trigger() ignored: in frontmatter");return}this.state==="queued"?(r("Already queued, resetting timer"),this.cancelQueueTimer()):this.state==="predicting"?(r("Was predicting, aborting"),this.aiProvider.abort()):this.state==="suggesting"&&(r("Was suggesting, clearing"),S(t)),this.setState("queued"),this.startQueueTimer(),r("Now queued, timer started for",this.settings.triggerDelay,"ms")}manualTrigger(t){if(r("manualTrigger() called"),this.state==="disabled"){r("manualTrigger() ignored: disabled");return}this.currentView=t;let i=t.state.doc.toString(),e=t.state.selection.main.head;if(D(i,e)||N(i,e)){r("manualTrigger() ignored: in code block or frontmatter");return}this.cancelQueueTimer(),this.aiProvider.abort(),this.state==="suggesting"&&S(t),this.setState("predicting"),r("Going directly to predicting"),this.predict()}cancelQueue(){r("cancelQueue() called, current state:",this.state),this.state==="queued"?(this.cancelQueueTimer(),this.setState("idle")):this.state==="predicting"?(this.aiProvider.abort(),this.setState("idle")):this.state==="suggesting"&&this.setState("idle")}dismiss(){if(this.state==="suggesting"&&this.currentView){let t=this.currentView;this.setState("idle"),requestAnimationFrame(()=>{S(t)})}}disable(){this.cancelQueueTimer(),this.aiProvider.abort(),this.state==="suggesting"&&this.currentView&&S(this.currentView),this.setState("disabled")}enable(){this.state==="disabled"&&this.setState("idle")}destroy(){this.cancelQueueTimer(),this.aiProvider.abort(),this.stateChangeCallbacks=[]}setState(t){if(this.state!==t){r("State:",this.state,"\u2192",t),this.state=t;for(let i of this.stateChangeCallbacks)i(t)}}startQueueTimer(){this.queueTimer=setTimeout(()=>{this.queueTimer=null,r("Queue timer fired, current state:",this.state),this.state==="queued"&&(this.setState("predicting"),this.predict())},this.settings.triggerDelay)}cancelQueueTimer(){this.queueTimer&&(clearTimeout(this.queueTimer),this.queueTimer=null,r("Queue timer cancelled"))}async predict(){if(r("predict() called"),!this.currentView||this.state!=="predicting"){r("predict() aborted: no view or wrong state");return}let t=this.currentView,e={...R(t,this.settings.contextChars,this.settings.includeHeadingTrail),mode:this.settings.mode};r("Calling AI with context, prefix length:",e.prefix.length);let n=await this.aiProvider.complete(e);if(r("AI returned:",n?n.substring(0,50)+"...":"null"),this.state!=="predicting"){r("State changed during prediction, aborting");return}n?t.state.selection.main.head===e.cursorPosition?(H(t,n),this.setState("suggesting")):(r("Cursor moved, discarding suggestion"),this.setState("idle")):this.setState("idle")}};var E=require("@codemirror/view"),W=require("@codemirror/state");var Q=require("@codemirror/view"),nt=!1;function l(...s){nt&&console.log("[ThoughtCompletion:Triggers]",...s)}function U(s,t){return Q.ViewPlugin.fromClass(class{constructor(e){this.idleTimer=null;this.lastDocLength=e.state.doc.length,t.setView(e),l("TriggerPlugin created")}update(e){let n=s();if(t.setView(e.view),!n.enabled){l("update() skipped: disabled");return}if(n.manualTriggerOnly){l("update() skipped: manualTriggerOnly");return}if(e.docChanged){let o=e.state.doc.length,g=o>this.lastDocLength,u=o-this.lastDocLength;this.lastDocLength=o,l("docChanged, isTyping:",g,"lengthDiff:",u),t.cancelQueue(),this.resetIdleTimer(e.view,n),g&&this.checkTriggers(e,n)}e.selectionSet&&!e.docChanged&&(l("Selection changed without doc change"),t.dismiss())}destroy(){this.clearIdleTimer(),l("TriggerPlugin destroyed")}checkTriggers(e,n){let o=e.state.selection.main.head,g=e.state.doc.lineAt(o),u=o>g.from?e.state.doc.sliceString(o-1,o):"";if(l("checkTriggers, charBefore:",JSON.stringify(u),"pos:",o,"line.to:",g.to),n.triggerOnPunctuation&&(l("triggerOnPunctuation enabled"),/[.!?]/.test(u))){l("Punctuation detected:",u);let h=o<e.state.doc.length?e.state.doc.sliceString(o,o+1):"";if(l("charAfter:",JSON.stringify(h),"pos === line.to:",o===g.to),!h||/\s/.test(h)||o===g.to){l("Punctuation trigger firing!"),t.trigger(e.view);return}else l("Punctuation trigger skipped: char after is not space/EOL")}if(n.triggerOnNewline){l("triggerOnNewline enabled, checking transactions...");for(let h of e.transactions)h.isUserEvent("input.type")&&h.changes.iterChanges((f,m,d,w,C)=>{let T=C.toString();l("Change inserted:",JSON.stringify(T)),T.includes(`
`)&&(l("Newline trigger firing!"),t.trigger(e.view))})}}resetIdleTimer(e,n){this.clearIdleTimer(),l("Idle timer reset, will fire in",n.triggerDelay,"ms"),this.idleTimer=setTimeout(()=>{this.idleTimer=null,l("Idle timer fired"),n.enabled&&!n.manualTriggerOnly&&t.trigger(e)},n.triggerDelay)}clearIdleTimer(){this.idleTimer&&(clearTimeout(this.idleTimer),this.idleTimer=null)}})}function K(s,t){let i=W.Prec.highest(E.keymap.of([{key:"Escape",run:o=>Y(o)?(S(o),t.dismiss(),!0):!1}])),e=E.EditorView.baseTheme({".thought-completion-ghost":{opacity:"0.5",fontStyle:"italic",color:"var(--text-muted)",pointerEvents:"none",userSelect:"none"}}),n=U(s,t);return[A,i,e,n]}var ot={idle:"Idle",queued:"Queued...",predicting:"Thinking...",suggesting:"Suggesting",disabled:"Off"},O=class extends P.Plugin{constructor(){super(...arguments);this.settings=V;this.stateMachine=null;this.statusBarEl=null}async onload(){await this.loadSettings(),this.stateMachine=new v(this.settings),this.settings.showStatusBar&&(this.statusBarEl=this.addStatusBarItem(),this.updateStatusBar(this.stateMachine.getState())),this.stateMachine.onStateChange(e=>{this.updateStatusBar(e)}),this.registerEditorExtension(K(()=>this.settings,this.stateMachine)),this.addSettingTab(new b(this.app,this)),this.addCommand({id:"trigger-suggestion",name:"Trigger suggestion",editorCallback:(e,n)=>{if(n instanceof P.MarkdownView){let o=this.getEditorView(n);o&&this.stateMachine&&this.stateMachine.manualTrigger(o)}}}),this.addCommand({id:"dismiss-suggestion",name:"Dismiss suggestion",editorCallback:()=>{this.stateMachine&&this.stateMachine.dismiss()}}),this.addCommand({id:"toggle-enabled",name:"Toggle suggestions on/off",callback:async()=>{this.settings.enabled=!this.settings.enabled,await this.saveSettings(),this.stateMachine&&this.stateMachine.updateSettings(this.settings)}});let i=[{id:"mode-auto",name:"Set mode: Auto",mode:"auto"},{id:"mode-questions",name:"Set mode: Questions",mode:"questions"},{id:"mode-structural",name:"Set mode: Structural",mode:"structural"},{id:"mode-critical",name:"Set mode: Critical",mode:"critical"},{id:"mode-connector",name:"Set mode: Connector",mode:"connector"}];for(let{id:e,name:n,mode:o}of i)this.addCommand({id:e,name:n,callback:async()=>{this.settings.mode=o,await this.saveSettings(),this.stateMachine&&this.stateMachine.updateSettings(this.settings)}})}onunload(){this.stateMachine&&(this.stateMachine.destroy(),this.stateMachine=null),this.statusBarEl=null}async loadSettings(){this.settings=Object.assign({},V,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.stateMachine&&this.stateMachine.updateSettings(this.settings),this.updateStatusBarVisibility()}updateStatusBarVisibility(){this.settings.showStatusBar&&!this.statusBarEl?(this.statusBarEl=this.addStatusBarItem(),this.stateMachine&&this.updateStatusBar(this.stateMachine.getState())):!this.settings.showStatusBar&&this.statusBarEl&&(this.statusBarEl.remove(),this.statusBarEl=null)}updateStatusBar(i){if(!this.statusBarEl)return;let e=this.settings.mode.charAt(0).toUpperCase()+this.settings.mode.slice(1),n=ot[i];this.statusBarEl.setText(`Thought: ${n} (${e})`),this.statusBarEl.removeClass("tc-idle","tc-queued","tc-predicting","tc-suggesting","tc-disabled"),this.statusBarEl.addClass(`tc-${i}`)}getEditorView(i){var e,n;return(n=(e=i.editor)==null?void 0:e.cm)!=null?n:null}};
